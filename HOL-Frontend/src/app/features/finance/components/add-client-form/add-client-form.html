<dialog class="modal" [open]="showModal()" dir="rtl">
  <div class="modal-box modal-xl">

    <!-- Header -->
    <div class="modal-header">
      <h3>โ ุฅุถุงูุฉ ูููู</h3>
      <button class="modal-close" (click)="closeModal()">โ</button>
    </div>

    <!-- Body Content -->
    <div class="modal-body">
      <form (ngSubmit)="addClient()">

        <!-- Tabs Navigation -->
        <div class="tabs tabs-boxed mb-4">
          <a class="tab" [class.tab-active]="activeTab() === 'basic'" (click)="activeTab.set('basic')">ุงูุจูุงูุงุช
            ุงูุฃุณุงุณูุฉ</a>
          <a class="tab" [class.tab-active]="activeTab() === 'contacts'" (click)="activeTab.set('contacts')">ุฃุฑูุงู
            ุงูุชูุงุตู</a>
          <a class="tab" [class.tab-active]="activeTab() === 'financial'" (click)="activeTab.set('financial')">ุงูุจูุงูุงุช
            ุงููุงููุฉ</a>
          <a class="tab" [class.tab-active]="activeTab() === 'attachments'"
            (click)="activeTab.set('attachments')">ุงููุฑููุงุช</a>
        </div>

        <!-- Tab 1: ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ -->
        <div *ngIf="activeTab() === 'basic'" class="tab-content">

          <!-- Row 1: Code, Name -->
          <div class="form-grid form-grid-3">
            <!-- Client Code -->
            <div class="form-field">
              <label class="form-label form-label-required">ููุฏ ุงููููู</label>
              <input type="text" [(ngModel)]="clientForm.code" name="code" class="form-input" required />
            </div>

            <!-- Client Name -->
            <div class="form-field" style="grid-column: span 2;">
              <label class="form-label form-label-required">ุงุณู ุงููููู</label>
              <div class="form-row">
                <input type="text" [(ngModel)]="clientForm.name" name="name" class="form-input" style="flex: 1;"
                  required />
                <button class="form-button form-button-outline" type="button" (click)="clientLookup.open()">
                  ุงุฎุชุฑ...
                </button>
              </div>
            </div>
          </div>

          <!-- Row 2: Contract Number, Sector, Legal Claimant -->
          <div class="form-grid form-grid-3">
            <div class="form-field">
              <label class="form-label form-label-required">ุฑูู ุงูุนูุฏ</label>
              <div class="form-row">
                <input type="text" [(ngModel)]="clientForm.contractNumber" name="contractNumber" class="form-input"
                  style="width: 80px;" required />
                <span style="padding: 0 0.5rem;">/</span>
                <select [(ngModel)]="clientForm.contractYear" name="contractYear" class="form-select"
                  style="width: 100px;">
                  <option *ngFor="let year of years" [value]="year">{{ year }}</option>
                </select>
              </div>
            </div>

            <!-- Sector -->
            <div class="form-field">
              <label class="form-label">ุงููุทุงุน</label>
              <select [(ngModel)]="clientForm.sector" name="sector" class="form-select">
                <option value="">ุงุฎุชุฑ ุงููุทุงุน</option>
                <option *ngFor="let s of sectors" [ngValue]="s">{{ s }}</option>
              </select>
            </div>

            <!-- Legal Claimant -->
            <div class="form-field">
              <label class="form-label">ุงููุฏุนู ุงููุงูููู</label>
              <input type="text" [(ngModel)]="clientForm.legalClaimant" name="legalClaimant" class="form-input" />
            </div>
          </div>

          <!-- Row 3: Cid, Address, Nationality -->
          <div class="form-grid form-grid-3">
            <div class="form-field">
              <label class="form-label">ุงูุฑูู ุงููุฏูู</label>
              <input type="text" [(ngModel)]="clientForm.cid" name="cid" class="form-input" />
            </div>

            <div class="form-field">
              <label class="form-label">ุงูุนููุงู</label>
              <input type="text" [(ngModel)]="clientForm.address" name="address" class="form-input" />
            </div>

            <div class="form-field">
              <label class="form-label">ุงูุฌูุณูุฉ</label>
              <input type="text" [(ngModel)]="clientForm.nationality" name="nationality" class="form-input" />
            </div>
          </div>


          <!-- Contract Details -->
          <div class="form-field">
            <label class="form-label">ุจูุงู ุงูุชุนุงูุฏ</label>
            <textarea [(ngModel)]="clientForm.contractDetails" name="contractDetails" class="form-textarea"
              rows="3"></textarea>
          </div>
        </div>

        <!-- Tab 2: ุฃุฑูุงู ุงูุชูุงุตู -->
        <div *ngIf="activeTab() === 'contacts'" class="tab-content">
          <!-- Add Contact Form -->
          <div class="form-section">
            <div class="form-section-title">ุฅุถุงูุฉ ุฑูู ุฌุฏูุฏ</div>
            <div class="form-row" style="gap: 1rem;">
              <div class="form-field" style="flex: 1;">
                <label class="form-label">ุฑูู ุงูุฌูุงู</label>
                <input type="text" [(ngModel)]="newContact.phone" name="phone" placeholder="ุงุฏุฎู ุฑูู ุงูุฌูุงู"
                  class="form-input" />
              </div>
              <div class="form-field" style="flex: 1;">
                <label class="form-label">ููุณูุจ ุฅูู</label>
                <input [(ngModel)]="newContact.relation" name="relation" placeholder="ููุณูุจ ุฅูู" class="form-input" />
              </div>
              <button type="button" class="form-button form-button-primary" style="align-self: flex-end;"
                (click)="addContact()">
                ุฅุถุงูุฉ
              </button>
            </div>
          </div>

          <!-- Contacts Table -->
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>ููุณูุจ ุฅูู</th>
                  <th>ุฑูู ุงูุฌูุงู</th>
                  <th>ุฅุฌุฑุงุก</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let c of contacts">
                  <td>{{ c.relation }}</td>
                  <td>{{ c.phone }}</td>
                  <td>
                    <button type="button" class="form-button form-button-danger" style="padding: 0.25rem 0.5rem;"
                      (click)="removeContact(c)">
                      โ
                    </button>
                  </td>
                </tr>
                <tr *ngIf="contacts.length === 0">
                  <td colspan="3" class="text-center" style="color: var(--text-color-secondary); padding: 2rem;">
                    ูุง ุชูุฌุฏ ุฃุฑูุงู ูุถุงูุฉ
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Tab 3: ุงูุจูุงูุงุช ุงููุงููุฉ -->
        <div *ngIf="activeTab() === 'financial'" class="tab-content">
          <!-- Add Financial Entry -->
          <div class="form-section">
            <div class="form-section-title">ุฅุถุงูุฉ ุตู ูุงูู</div>
            <div class="form-row" style="gap: 1rem;">
              <select [(ngModel)]="newFinancialEntry.type" name="newType" class="form-select" style="flex: 1;">
                <option value="">ุงุฎุชุฑ ุงูููุน</option>
                <option *ngFor="let type of financialTypes" [ngValue]="type">
                  {{ type }}
                </option>
              </select>
              <button type="button" class="form-button form-button-primary" (click)="addFinancialEntry()">
                ุฅุถุงูุฉ ุตู
              </button>
            </div>
          </div>

          <!-- Financial Table -->
          <div class="table-container">
            <table class="table">
              <thead>
                <tr style="background: var(--primary-color); color: white;">
                  <th>#</th>
                  <th>ุงุชุนุงุจ</th>
                  <th>ูุฏู</th>
                  <th>ุชูููุฐ</th>
                  <th>ูุถุงุฆู ูุฏูู</th>
                  <th>ูุถุงุฆู ูุฏุนู ุนููู</th>
                  <th>ุฎุจุฑุงุก</th>
                  <th>ุงุฌุฑุงุก</th>
                  <th>ุฅุฌุฑุงุกุงุช</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let entry of financialEntries(); let i = index">
                  <th style="font-weight: bold; color: var(--primary-color);">{{ entry.type }}</th>
                  <td *ngFor="let col of financialCols" class="editable-cell" contenteditable="true"
                    (blur)="updateFinancialValue($event, entry, col.key)">
                    {{ entry?.values?.[col.key] || '' }}
                  </td>
                  <td>
                    <button type="button" class="form-button form-button-danger" style="padding: 0.25rem 0.5rem;"
                      (click)="deleteFinancialEntry(entry)">
                      โ
                    </button>
                  </td>
                </tr>
                <tr *ngIf="financialEntries().length === 0">
                  <td colspan="9" class="text-center" style="color: var(--text-color-secondary); padding: 2rem;">
                    ูุง ุชูุฌุฏ ุจูุงูุงุช ูุงููุฉ
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Tab 4: ุงููุฑููุงุช -->
        <div *ngIf="activeTab() === 'attachments'" class="tab-content">
          <!-- Add Attachment Form -->
          <div class="form-section">
            <div class="form-section-title">ุฅุถุงูุฉ ูุฑูู</div>
            <input type="file" #fileInput class="hidden" (change)="onFileSelected($event)" />
            <div class="form-row" style="gap: 1rem;">
              <div class="form-field" style="flex: 1;">
                <label class="form-label">ููุงุญุธุงุช ุงููุฑูู</label>
                <input type="text" [(ngModel)]="attachmentNote" name="attachmentNote" class="form-input"
                  placeholder="ููุงุญุธุงุช ุงููุฑูู" />
              </div>
              <button type="button" class="form-button form-button-secondary" style="align-self: flex-end;"
                (click)="fileInput.click()">
                ุงุฎุชุฑ ููู
              </button>
              <button type="button" class="form-button form-button-primary" style="align-self: flex-end;"
                (click)="addAttachmentToQueue()">
                ุฅุถุงูุฉ
              </button>
            </div>
            <div *ngIf="selectedFile" style="margin-top: 0.5rem; color: var(--primary-color);">
              ๐ {{ selectedFile.name }}
            </div>
          </div>

          <!-- Attachments Table -->
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>ุงูุจูุงู</th>
                  <th>ุงุณู ุงูููู</th>
                  <th>ุฅุฌุฑุงุก</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let att of attachments">
                  <td>{{ att?.note }}</td>
                  <td>{{ att?.file?.name }}</td>
                  <td>
                    <button type="button" class="form-button form-button-danger" style="padding: 0.25rem 0.5rem;"
                      (click)="removeAttachment(att)">
                      โ
                    </button>
                  </td>
                </tr>
                <tr *ngIf="attachments.length === 0">
                  <td colspan="3" class="text-center" style="color: var(--text-color-secondary); padding: 2rem;">
                    ูุง ุชูุฌุฏ ูุฑููุงุช ูุถุงูุฉ
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

      </form>
    </div>

    <!-- Footer with action buttons -->
    <div class="modal-footer">
      <button type="button" class="form-button form-button-secondary" (click)="closeModal()">
        โ ุฑุฌูุน
      </button>
      <button type="button" class="form-button form-button-success" (click)="addClient()" [disabled]="isSaving()">
        {{ isSaving() ? 'ุฌุงุฑู ุงูุญูุธ...' : '๐พ ุญูุธ' }}
      </button>
    </div>
  </div>
</dialog>

<app-lookup-modal #clientLookup [title]="'ุงุฎุชุฑ ุงููููู'" [columns]="['code','name']" [data]="clientsData"
  (itemSelected)="onClientSelected($event)">
</app-lookup-modal>